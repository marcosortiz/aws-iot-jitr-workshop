## Command-line tools

This project features two scripts in this directory :

  - [`create-and-register-ca.sh`](create-and-register-ca.sh) starts the process of creating an X.509 Root Certificate of Authority and will, if you accept it, register the newly created Root CA on AWS IoT, activate it, and enable its auto registration status.
  - [`create-device-certificate.sh`](create-device-certificate.sh) uses a previously created Root Certificate of Authority to sign a new device certificate which is ready to be provisionned on a device.

In order to be able to execute the above scripts, make sure that they are executable. On a Unix system, you can run `chmod +x <your_script>` in order to do so.

### Create and register a CA

The `create-and-register-ca.sh` script does not take mandatory arguments, but you can specify optional one:

  - **-h** - displays the usage description of the script.
  - **-d** - (Optional) the path of the directory in which the generated Root CA certificates will be stored. The default path is `./root-ca-certs`.
  - **-o** - (Optional) - takes as an option the path to the OpenSSL configuration file to use for the Certificate Authority. The default path is `./config/openssl-ca.conf`.

Once you run the script, it will generate all the keys required to produce and register the new CA. The script will prompt you whether you want to register the CA right away on AWS IoT after its creation.

A sample configuration file associated with the creation of the CA is located by default at `./config/openssl-ca.conf`. In this file you can customize OpenSSL properties, and update the informations registered in the certificate (e.g `OrganizationName`, `Country`, `CommonName`, etc.).

### Create a device certificate

The `create-device-certificate.sh` script does not take mandatory arguments, but you can specify the following optional ones :

  - **-h** - displays the usage description of the script.
  - **-o** - (Optional) - takes as an option the path to the OpenSSL configuration file to use for the device certificate. The default path is `./config/openssl-device.conf`.
  - **-d** - (Optional) - the path of the directory containing the Root CA certificates. The default directory path is `./root-ca-certs`.
  - **-r** - (Optional) - takes as an option the path of the resulting AWS Root CA certificate that will automatically be downloaded. Its default value is `aws-root-cert.pem`.

The script when run will create a new set of device certificates that will be ready to use to connect to AWS IoT. The script will automatically download the AWS Root certificate to allow you to test the connection right away.

> Take a look at the default configuration file to customize informations associated with the certificate before you generate one.

### Testing the certificates

Once you CA has been registered and your device certificate has been generated, you can test the connection to AWS IoT using the `mosquitto_pub` command-line tool.

```bash
mosquitto_pub --cafile aws-root-cert.pem --cert device-and-ca-certificate.crt --key my-device-certificate.key -h <prefix>.iot.<region>.amazonaws.com -p 8883 -q 1 -t device/topic -i anyclientID --tls-version tlsv1.2 -m "Hello" -d
```

Note that your very first connection to AWS IoT will fail, since the JITR process is triggered on a first connection. Once the Lambda function is triggered and will have created and activated your device certificate in the AWS IoT registry, the connection will then succeed. 

### Working with multiple accounts

If you have registered multiple account credentilas into your AWS CLI's configuration, you can select on which account you'd want to deploy the CA by specifying an inline environment value :

```bash
AWS_PROFILE=my-profile ./create-and-register-ca.sh
```

### Working with multiple regions

If you'd like to set the AWS region in which you want to register your new Root CA, you can pass it as an environment variable.

```bash
AWS_DEFAULT_REGION=us-east-1 ./create-and-register-ca.sh
```
