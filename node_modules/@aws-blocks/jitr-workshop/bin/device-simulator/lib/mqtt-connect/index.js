const mqttClient = require('aws-iot-device-sdk');

/**
 * Initiates a connection to AWS IoT using the given
 * device, Root CA and endpoint information. This function
 * managed an automatic reconnection to AWS IoT until the device
 * certificate is validated by the JITR process.
 * @param {*} parameters the device parameters object.
 * @param {*} rootCa the path to the AWS RooT CA.
 * @param {*} endpoint the AWS IoT endpoint to use.
 */
module.exports = (parameters, rootCa, endpoint) => {
  return new Promise((resolve, reject) => {
    // The AWS IoT device profile.
    const client = mqttClient.device({
      'host': endpoint,
      'port': 8883,
      'keyPath': parameters.devicePrivateKey,
      'certPath': parameters.deviceCertificate,
      'caPath': rootCa,
      'clientId': parameters.thingName,
      'reconnectPeriod': 3 * 1000
    });
    // Listening to the `connect` event.
    client.once('connect', () => resolve(client));
    // Listening to the `error` event.
    client.once('error', (err) => reject(err));
  });
};